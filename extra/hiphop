# hiphop-php functions and variables
# https://github.com/facebook/hiphop-php

hiphop_deps=(gcc icu4c gd oniguruma re2c binutils libmemcached openssl tbb libpcre libexpat boost cmake mysql mcrypt)
function check_hiphop_deps() {
  # e.g. "^(gcc|icu4c|gd|...|mcrypt)$"
  hiphop_deps_regex="^(${hiphop_deps// /|})$"
  installed_deps=$(brew ls | awk '{print $1 $2 $3}' | egrep "$hiphop_deps_regex")


  # Iterate through all the deps to check that we have all of them
  missing_deps=() # empty array
  IFS=" "
  for dep in $hiphop_deps
  do
    # If == 0, then not in $installed_deps, so add it to missing_deps
    [[ $installed_deps[(I)$dep] == 0 ]] && missing_deps+=$dep
  done

  if [[ ${#missing_deps} > 0 ]]
  then
    print "!!! You are missing the following HipHop dependencies."
    print "!!! To get them, including GCC, run \`install_hiphop_deps\`"
    print "(And don't forget to install patched versions of curl and libevent.)"
    print -C 1 $missing_deps
  else
    print "You have all required Hiphop dependencies!"
  fi
}

function install_hiphop_deps {
  local formula_dir=$(brew --prefix)/Library/Formula
  print -n "Getting gcc formula..."
  curl -o $formula_dir/gcc.rb \
    https://github.com/andreabedini/homebrew/raw/cd8d8d943634125eeb6b0eba1e7280c32fce9f4e/Library/Formula/gcc.rb
  print "done."
  # Autoconf
  print -n "Getting autoconf formula..."
  curl -o $formula_dir/autoconf.rb \
    https://github.com/andreabedini/homebrew/raw/bffe1ac1b3863a607d3e6120009f4a0feb4236dc/Library/Formula/autoconf.rb
  print "done."
  # Automake
  print -n "Getting automake formula..."
  curl -o $formula_dir/automake.rb \
    https://github.com/andreabedini/homebrew/raw/bffe1ac1b3863a607d3e6120009f4a0feb4236dc/Library/Formula/automake.rb
  print "done."

  print "Running \`brew install $hiphop_deps\`, after that you should be good to go."
  brew install $hiphop_deps
}


export DID_SET_HIPHOP_VARS='no'
function set_hiphop_vars {
  [[ $DID_SET_HIPHOP_VARS == 'yes' ]] && return
  export CMAKE_PREFIX_PATH=~/php-builder/
  # "$TBB_INSTALL_DIR"/"$TBB_INSTALL_DIR" should contain TBB libs
  export TBB_INSTALL_DIR="$(brew --prefix tbb)"
  export TBB_ARCH_PLATFORM="lib"
  export HPHP_HOME=$CMAKE_PREFIX_PATH/hiphop-php
  export HPHP_LIB=$CMAKE_PREFIX_PATH/hiphop-php/bin
  #export PATH=$(brew --prefix gcc)/bin:$PATH
  export DID_SET_HIPHOP_VARS='yes'
}

# "hiphoP CMake" => "pcm"
# Should be run in hiphop-php directory
function pcm {
  export LIBEVENT_INSTALLED=$CMAKE_PREFIX_PATH/libevent-installed/
  local gcc_bin=/usr/local/Cellar/gcc/4.5.1/bin
  local icu_dir=/usr/local/Cellar/icu4c/4.4.1/
  local cclient_dir=~/imap-2007e/c-client
  #git clean -fdx && \
  cmake \
    -D CMAKE_PREFIX_PATH:FILEPATH=$CMAKE_PREFIX_PATH \
    -D CMAKE_INSTALL_PREFIX:PATH=~/hphp-install-prefix \
    -D CMAKE_C_COMPILER:FILEPATH=$gcc_bin/gcc-4.5 \
    -D CMAKE_CXX_COMPILER:FILEPATH=$gcc_bin/c++-4.5 \
    -D LIBEVENT_LIB_DIR:FILEPATH=$LIBEVENT_INSTALLED/lib \
    -D LIBEVENT_INCLUDE_DIR:FILEPATH=$LIBEVENT_INSTALLED/include \
    -D ICU_INCLUDE_DIR:FILEPATH=$icu_dir/include/ \
    -D ICU_LIBRARY:FILEPATH=$icu_dir/lib \
    -D CCLIENT_INCLUDE_PATH:FILEPATH=$cclient_dir \
    -D CCLIENT_INCLUDE_PATH:FILEPATH=$cclient_dir \
    -D CCLIENT_LIBRARY:FILEPATH=$cclient_dir \
    .
}

set_hiphop_vars
check_hiphop_deps
